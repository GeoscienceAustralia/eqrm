"""
 Title: structures.py

  Author:  Peter Row, peter.row@ga.gov.au
           Duncan Gray, duncan.gray@ga.gov.au

  Description: Classes and functions for holding structure information.

  Version: $Revision: 1716 $
  ModifiedBy: $Author: rwilson $
  ModifiedDate: $Date: 2010-06-18 13:58:01 +1000 (Fri, 18 Jun 2010) $

  Copyright 2007 by Geoscience Australia
"""


from os.path import join
from scipy import where, array, asarray, allclose, sum, in1d, unique, alltrue
import copy

from eqrm_code.csv_interface import csv_to_arrays
from eqrm_code.sites import Sites
from eqrm_code.vulnerability_model import Vulnerability_Set

attribute_conversions = {'LATITUDE': float,
                         'LONGITUDE': float,
                         'STRUCTURE_CLASSIFICATION': str,
                         'BUILDING_COST_DENSITY': float,
                         'FLOOR_AREA': float,
                         'SURVEY_FACTOR': float,
                         #'POSTCODE': int,
                         #'SUBURB': str,
                         'BID': int,
                         'SITE_CLASS': str}


class Structures_Vulnerability(Sites):

    def __init__(self, 
                 latitude, 
                 longitude, 
                 vulnerability_set,
                 **attributes):
        """Create an object holding all Structures data for user defined 
        vulnerability curves
        """

        # inherit setup from Sites, add building parameters
        Sites.__init__(self, latitude, longitude, **attributes)
        self.vulnerability_set = vulnerability_set
        
        # Validate that the curves match this set
        self.validate_vulnerability_set()


    @classmethod
    def from_csv(cls, sites_filename, eqrm_flags):
        """Read structures data from a file.
        Extract structure parameters from building_parameters_table.

        parameters
          sites_filename is actually a file handle
        """
        
        sites_dict = csv_to_arrays(sites_filename, **attribute_conversions)
        
        latitude = sites_dict.pop("LATITUDE")
        longitude = sites_dict.pop("LONGITUDE")
        
        # create copy of attributes
        attributes = copy.copy(sites_dict)
        
        # Create the vulnerability curves
        vulnerability_set = Vulnerability_Set.from_xml(eqrm_flags)
        
        # create structures:
        return cls(latitude, longitude, vulnerability_set, **attributes)

    
    def validate_vulnerability_set(self):
        """The vulnerability set must provide curves for all sites in this
        object. A Vulnerability_Function needs to be defined to match each
        attributes['STRUCTURE_CLASSIFICATION'] identifier.
        
        Raises a RuntimeError if it cannot find a match.
        """
        if self.vulnerability_set is None:
            raise RuntimeError('Vulnerability Set must not be None')
        
        # Function IDs for the vulnerability set
        curves_defined = self.vulnerability_set.vulnerability_functions.keys()
        
        # Sites STRUCTURE_CLASSIFICATIONs
        structure_classifications = self.attributes['STRUCTURE_CLASSIFICATION']
        structure_classifications = unique(structure_classifications)
        
        # Are there any unique structure classifications that are not in the 
        # curves defined?
        in_curves_defined = in1d(structure_classifications, curves_defined)
        if not alltrue(in_curves_defined):
            msg = 'The following structures do not have a vulnerability curve: '
            msg += '%s' % structure_classifications[where(in_curves_defined == False)]
            raise RuntimeError(msg)
        
        

    def calc_loss(self, SA):
        """
        Calculate the economic loss at a site for a user defined vulnerability
        curve. 
        
        The curve data should be loaded in with the analysis function
        load_data() and self.vulnerability_set defined. If it hasn't and this 
        function is called a runtime error is thrown.
        
        SA                 array of Spectral Acceleration, in g, with axis;
                               sites, events, periods
                           the site axis usually has a size of 1
        
        Returns economic_loss where:
          economic_loss    A dollar loss, with the the dimensions of;
                           (site, event)
        """
        
        if self.vulnerability_set is None:
            raise RuntimeError('Vulnerability set not found')
        
        # SA shape:
        # (sites, pseudo_events, periods)
        
        # Calculate intensity measure level
        IML = self.vulnerability_set.intensity_conversion(SA)
        
        # TODO: Can we assume this will be for a single site?
        func_id = self.attributes['STRUCTURE_CLASSIFICATION'][0]
        
        # Get mean and sigma for this measure level and site type
        mean_loss, sigma = self.vulnerability_set.calc_mean(func_id, IML)
        
        # Get the loss_ratio by taking a random sample
        loss_ratio = self.vulnerability_set.sample(func_id, mean_loss, sigma)
        
        # Perform a cutoff for the ratio limits
        loss_ratio = self.vulnerability_set.ratio_cutoff(loss_ratio)
        
        # Economic loss factors
        bcd = self.attributes['BUILDING_COST_DENSITY']
        fa = self.attributes['FLOOR_AREA']
        sf = self.attributes['SURVEY_FACTOR']
        
        # Calculate economic loss
        economic_loss = bcd * fa * sf * loss_ratio
        
        # Return figured summed at the periods axis
        # Result shape (sites, pseudo_events)
        return economic_loss.sum(axis=-1)

    def __getitem__(self, key):
        """Get single indexed entry from a Structures object."""

        # if 'key' is naked int, make a list
        if isinstance(key, int):
            key = [key]

        # get indexed .attributes
        attributes = {}
        for k in self.attributes.keys():
            attributes[k] = self.attributes[k][key]

        # create shiny new Structures object with this single structure
        return Structures_Vulnerability(self.latitude[key], 
                                        self.longitude[key],
                                        self.vulnerability_set, 
                                        **attributes)


