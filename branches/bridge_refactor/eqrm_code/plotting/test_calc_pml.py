#!/usr/bin/env python

'''Test the calc_pml.py module.'''

import os
import unittest
import random
import tempfile
import shutil
import scipy

from eqrm_code.plotting import calc_pml


class TestCalcPml(unittest.TestCase):
    def setUp(self):
        pass
    
    def tearDown(self):
        pass

    def test_real_world_small(self):
        # create function input values.
        # values are from MatLab execution of calc_pml.m
        # with 'format long e' controlling display precision
        # and a thinned data set.
        saved_ecloss = scipy.array([[3.60333160e+02, 4.37917190e+03, 4.39664990e+01,
                                     3.23449590e+04, 3.75249580e+03, 0.00000000e+00,
                                     0.00000000e+00, 6.81551510e+03, 4.76537890e+04,
                                     0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
                                    [0.00000000e+00, 5.44164450e+03, 4.65146000e+03,
                                     7.78904220e+04, 8.54062500e+03, 0.00000000e+00,
                                     0.00000000e+00, 7.47781690e+03, 5.75973630e+05,
                                     1.10220140e+04, 0.00000000e+00, 0.00000000e+00],
                                    [0.00000000e+00, 1.51306500e+02, 4.47965300e+02,
                                     0.00000000e+00, 2.01063440e+04, 0.00000000e+00,
                                     0.00000000e+00, 4.02932850e+04, 4.22473240e+04,
                                     0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
                                    [0.00000000e+00, 1.18392500e+03, 0.00000000e+00,
                                     2.17403150e+03, 4.20803910e+04, 0.00000000e+00,
                                     0.00000000e+00, 1.82294670e+05, 3.22699820e+04,
                                     0.00000000e+00, 0.00000000e+00, 0.00000000e+00]])

        saved_ecbval2 = [1.657488601000000e+006,
                         1.297431077000000e+006,
                         1.559989253000000e+006,
                         7.915145563000001e+005]
        
        nu = scipy.array([4.630686287680000e-003,
                          1.060828942660000e-002,
                          5.316739231220000e-003,
                          4.033159153080000e-003,
                          3.059464090050000e-003,
                          1.267327623180000e-001,
                          4.828586998700000e-002,
                          4.916231738260000e-004,
                          1.801492034580000e-004,
                          5.811644129970000e-004,
                          1.804422031540000e-002,
                          1.336441244060000e-002])

        expected_pml_curve = scipy.array([[9.51625820e-02, 6.00199073e-02, 3.75872521e-02,
                                           2.34347758e-02, 1.45707961e-02, 9.04403025e-03,
                                           5.60763146e-03, 3.47464997e-03, 2.15211556e-03,
                                           1.33263269e-03, 8.25063633e-04, 5.10766492e-04,
                                           3.16177771e-04, 1.95715023e-04, 1.21145427e-04,
                                           7.49866093e-05, 4.64148111e-05, 2.87294356e-05,
                                           1.77826360e-05, 1.10068811e-05, 6.81289748e-06,
                                           4.21695614e-06, 2.61015381e-06, 1.61559679e-06,
                                           9.99999500e-07],
                                          [1.58181580e+02, 2.66519196e+02, 3.33576477e+02,
                                           5.75909229e+03, 3.32106875e+04, 6.65957578e+04,
                                           1.01022586e+05, 1.50191781e+05, 1.91123172e+05,
                                           2.16458297e+05, 2.32139875e+05, 3.87821969e+05,
                                           5.70469563e+05, 6.83522188e+05, 6.98144750e+05,
                                           6.98144750e+05, 6.98144750e+05, 6.98144750e+05,
                                           6.98144750e+05, 6.98144750e+05, 6.98144750e+05,
                                           6.98144750e+05, 6.98144750e+05, 6.98144750e+05,
                                           6.98144750e+05],
                                          [2.98094526e-03, 5.02257681e-03, 6.28627696e-03,
                                           1.08530582e-01, 6.25858218e-01, 1.25500270e+00,
                                           1.90377919e+00, 2.83037684e+00, 3.60173236e+00,
                                           4.07917494e+00, 4.37469560e+00, 7.30853784e+00,
                                           1.07505472e+01, 1.28810335e+01, 1.31565969e+01,
                                           1.31565969e+01, 1.31565969e+01, 1.31565969e+01,
                                           1.31565969e+01, 1.31565969e+01, 1.31565969e+01,
                                           1.31565969e+01, 1.31565969e+01, 1.31565969e+01,
                                           1.31565969e+01]])

        # call function
        pml_curve = calc_pml.calc_pml(saved_ecloss, saved_ecbval2, nu)

        # test return values
        self.failUnless(scipy.allclose(expected_pml_curve, pml_curve))

         
if __name__ == '__main__':
    unittest.main()
